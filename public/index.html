<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bible Reading Plan Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom color configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // REVERTED TO ORIGINAL VIBRANT COLORS
                        'primary-teal': '#008080',
                        'secondary-gold': '#FFD700',
                        'dark-teal': '#006666',
                        'light-gray': '#FAFAFA', // Softer background
                    },
                    fontFamily: {
                        // Using system font stack (San Francisco/Segoe UI/Roboto)
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Removed html2canvas import -->
    
    <!-- Firebase Imports (Minimal Set) -->
    <script type="module">
        // Global State Variables
        window.currentPlan = null;
        window.currentPlanDetails = null;
        window.userId = null;
        
        // --- MINIMAL FIREBASE IMPORTS (No Firestore since history/sharing is gone) ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: Firestore functions were slightly adjusted to match best practices
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GEMINI API CONSTANTS ---
        const API_KEY = "AIzaSyCb5IaHMO36vJ7VSpSYPbIWC2pSctTJlgs";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        // ----------------------------

        // --- FIREBASE INITIALIZATION (Streamlined to only handle Auth/UID) ---
        window.firebaseInit = async function() {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                setLogLevel('debug');

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    window.userId = auth.currentUser?.uid || crypto.randomUUID();
                    document.getElementById('user-id-display').textContent = `User ID: ${window.userId}`;
                    
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    window.userId = crypto.randomUUID();
                    document.getElementById('user-id-display').textContent = `User ID: ${window.userId} (Anon Error)`;
                }
            } else {
                console.warn("Firebase config not found. Running in standalone mode.");
                window.userId = crypto.randomUUID();
                document.getElementById('user-id-display').textContent = `User ID: ${window.userId} (Anon Error)`;
            }
        }

        window.addEventListener('load', window.firebaseInit);

        // --- UTILITY FUNCTIONS ---

        // Utility function to safely extract JSON array/object from text, handling pre-text and wrappers.
        function extractJson(text) {
            let jsonString = null;

            let match = text.match(/```json\s*([\s\S]*?)\s*```/);
            if (match) {
                jsonString = match[1];
            }

            if (!jsonString) {
                const firstBracket = text.indexOf('[');
                const lastBracket = text.lastIndexOf(']');
                
                if (firstBracket !== -1 && lastBracket !== -1 && lastBracket > firstBracket) {
                    jsonString = text.substring(firstBracket, lastBracket + 1);
                }
            }
            
            if (jsonString) {
                try {
                    return JSON.parse(jsonString.trim());
                } catch (e) {
                    console.error("Failed to parse extracted JSON string:", e);
                    console.error("Problematic JSON snippet:", jsonString.trim().substring(0, 200) + '...');
                    return null;
                }
            }
            return null;
        }

        // Utility function for exponential backoff retry logic (kept for completeness)
        async function fetchWithRetry(url, options, retries = 3) {
             for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed.`, error);
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        /**
         * Copies text to the clipboard (kept for screenshot download function)
         */
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px'; // Move off-screen
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(textarea);
        }

        // --- RENDER & DISPLAY FUNCTIONS ---
        
        function displayError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.remove('hidden');
            document.getElementById('loading-message').classList.add('hidden');
            document.getElementById('generate-button').disabled = false;
            document.getElementById('spinner').classList.add('hidden');
            document.getElementById('print-options').classList.add('hidden');
        }

        function renderPlan(planData) {
            const outputDiv = document.getElementById('plan-output');
            outputDiv.innerHTML = '';
            document.getElementById('error-message').classList.add('hidden');
            
            if (!planData || planData.length === 0) {
                outputDiv.innerHTML = '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-lg">The AI did not generate a plan. Please try a different prompt.</p>';
                document.getElementById('print-options').classList.add('hidden');
                return;
            }

            document.getElementById('print-options').classList.remove('hidden');

            const html = planData.map(day => `
                <div class="bg-white p-6 rounded-xl shadow-md transition duration-300 hover:shadow-lg">
                    <h3 class="text-xl font-bold text-primary-teal mb-2">Day ${day.day}: ${day.theme}</h3>
                    
                    <!-- MODIFIED: Added "To read:" prefix -->
                    <p class="text-base text-gray-700 mb-4">
                        <span class="font-semibold text-primary-teal">To read:</span> 
                        <span class="text-dark-teal">${day.scripture}</span>
                    </p>
                    
                    ${day.prayerPrompt ? `
                        <div class="mt-4 bg-gray-50 p-4 rounded-lg border-l-4 border-dark-teal">
                            <p class="font-semibold text-dark-teal mb-1 flex items-center">
                                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 2a3 3 0 00-3 3v2a3 3 0 006 0V5a3 3 0 00-3-3zM3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM4 11a1 1 0 011-1h10a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4z"/>
                                </svg>
                                Daily Prayer Prompt:
                            </p>
                            <p class="text-gray-800 text-sm">${day.prayerPrompt}</p>
                        </div>
                    ` : ''}
                    
                    ${day.reflectionQuestions && day.reflectionQuestions.length > 0 ? `
                        <div class="mt-4">
                            <p class="font-semibold text-gray-700 mb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-secondary-gold" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.868.504l-3.232 5.044A1 1 0 007 16h6a1 1 0 00.1-1.552l-3.232-5.044A1 1 0 0010 7z" clip-rule="evenodd" />
                                </svg>
                                Journal Prompts:
                            </p>
                            <ul class="list-disc pl-5 space-y-1 text-gray-600 text-sm">
                                ${day.reflectionQuestions.map(q => `<li>${q}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            outputDiv.innerHTML = html;
        }

        // --- PRINTING FUNCTIONS ---
        
        window.printSimplePlan = function() {
            if (!window.currentPlan || !window.currentPlanDetails) {
                displayError("No plan generated yet to print.");
                return;
            }

            const promptText = window.currentPlanDetails.prompt;
            const durationText = window.currentPlanDetails.duration;

            let printContent = `
                <div class="printable-content p-8">
                    <h1 style="text-align: center; color: #008080; font-size: 24px; font-weight: bold; margin-bottom: 5px;">BIBLEPLAN.AI Reading Plan</h1>
                    <h2 style="text-align: center; color: #555; font-size: 16px; margin-bottom: 20px;">Topic: ${promptText} (${durationText} Days)</h2>
            `;

            window.currentPlan.forEach(day => {
                const prayerHtml = day.prayerPrompt 
                    ? `<p class="print-prayer-prompt">Prayer Prompt:</p>
                       <p class="print-prayer-text">${day.prayerPrompt}</p>`
                    : '';
                    
                const questionsHtml = day.reflectionQuestions && day.reflectionQuestions.length > 0
                    ? `<p class="print-journal-prompt">Journal Prompts:</p>
                       <ul class="print-journal-list">
                           ${day.reflectionQuestions.map(q => `<li>${q}</li>`).join('')}
                       </ul>`
                    : '';

                // NOTE: Passage text is ALWAYS included in printout for the detailed print view
                printContent += `
                    <div class="print-day-card">
                        <h3 class="print-day-title">Day ${day.day}: ${day.theme}</h3>
                        <p class="print-scripture-ref">Scripture: ${day.scripture}</p>
                        <p class="print-passage-text">${day.passageText}</p>
                        ${prayerHtml}
                        ${questionsHtml}
                    </div>
                    <div class="break-after"></div>
                `;
            });

            printContent += `</div>`;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Detailed Reading Plan Printout</title>
                        <style>
                            /* Optimized Styles for Detailed Printout */
                            @media print {
                                body { margin: 20px; font-family: sans-serif; }
                                .print-day-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
                                h1 { font-size: 24pt; color: #008080; margin: 0; padding: 0; }
                                h2 { font-size: 14pt; color: #555; margin-bottom: 20px; }
                                h3 { font-size: 16pt; color: #008080; margin-top: 10px; }
                                .print-scripture-ref { font-size: 10pt; font-weight: 600; color: #006666; margin-bottom: 5px; }
                                .print-passage-text { font-size: 10pt; color: #444; font-style: italic; white-space: pre-wrap; line-height: 1.5; margin-bottom: 10px; }
                                .print-prayer-prompt, .print-journal-prompt { font-weight: bold; color: #008080; margin-top: 15px; margin-bottom: 5px; font-size: 10pt; }
                                .print-journal-list { list-style-type: disc; margin-left: 20px; color: #555; font-size: 10pt; }
                                .break-after { page-break-after: always; }
                            }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        window.printHabitTracker = function() {
            if (!window.currentPlan || !window.currentPlanDetails) {
                displayError("No plan generated yet to print.");
                return;
            }

            const promptText = window.currentPlanDetails.prompt;
            const durationText = window.currentPlanDetails.duration;
            const includePrayer = window.currentPlanDetails.includePrayer; // Use stored detail

            let tableRows = window.currentPlan.map(day => `
                <tr>
                    <td>${day.day}</td>
                    <td>${day.theme}</td>
                    <td>${day.scripture}</td>
                    <td></td>
                    <td></td>
                    ${includePrayer ? '<td></td>' : ''}
                </tr>
            `).join('');
            
            const prayerHeader = includePrayer ? '<th style="width: 10%;">Prayed?</th>' : '';

            let printContent = `
                <div class="printable-content p-8">
                    <h1 style="text-align: center; color: #008080; font-size: 24px; font-weight: bold; margin-bottom: 5px;">BIBLEPLAN.AI Habit Tracker</h1>
                    <h2 style="text-align: center; color: #555; font-size: 16px; margin-bottom: 20px;">Topic: ${promptText} (${durationText} Days)</h2>
                    <table class="tracker-table">
                        <thead>
                            <tr class="tracker-header">
                                <th style="width: 10%;">Day</th>
                                <th style="width: 25%;">Theme</th>
                                <th style="width: 35%;">Scripture</th>
                                <th style="width: 10%;">Read?</th>
                                <th style="width: 10%;">Journal?</th>
                                ${prayerHeader}
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Habit Tracker Printout</title>
                        <style>
                            /* Optimized Styles for Tracker Printout */
                            @media print {
                                h1, h2 { margin: 0; padding: 0; }
                                h1 { font-size: 24pt; color: #008080; }
                                h2 { font-size: 14pt; color: #555; margin-bottom: 20px; }
                                .tracker-table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin-top: 20px;
                                }
                                .tracker-table th, .tracker-table td {
                                    border: 1px solid #333;
                                    padding: 8px;
                                    text-align: left;
                                    font-size: 10pt;
                                }
                                .tracker-table th {
                                    background-color: #f0f0f0;
                                }
                                body { margin: 20px; }
                            }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // --- NEW: Simplified Print Function for Screenshot/Minimal View ---

        window.printMinimalList = function() {
            if (!window.currentPlan || !window.currentPlanDetails) {
                displayError("No plan generated yet to create a snapshot.");
                return;
            }

            const promptText = window.currentPlanDetails.prompt;
            const durationText = window.currentPlanDetails.duration;
            const includePrompts = document.getElementById('journal-prompts').checked;
            const includePrayer = document.getElementById('prayer-prompt').checked;

            let listContent = window.currentPlan.map(day => {
                let dayContent = `<li class="list-item">
                    <span class="day-ref">Day ${day.day}:</span> 
                    <span class="scripture-ref">${day.scripture}</span>
                </li>`;

                if (includePrayer && day.prayerPrompt) {
                    dayContent += `<li class="prompt-item prayer-prompt">Prayer: ${day.prayerPrompt}</li>`;
                }

                if (includePrompts && day.reflectionQuestions && day.reflectionQuestions.length > 0) {
                    const prompts = day.reflectionQuestions.map((q, i) => `(${i+1}) ${q}`).join(' ');
                    dayContent += `<li class="prompt-item journal-prompt">Journal: ${prompts}</li>`;
                }
                
                return dayContent;
            }).join('');

            let printContent = `
                <div class="minimal-list-content">
                    <h1 class="list-title">BIBLEPLAN.AI Snapshot</h1>
                    <h2 class="list-subtitle">Topic: ${promptText} (${durationText} Days)</h2>
                    <ul class="plan-list">
                        ${listContent}
                    </ul>
                </div>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Minimal Plan Snapshot</title>
                        <style>
                            /* Minimal Styles for Screenshot/PDF Save */
                            body { margin: 0; padding: 0; font-family: sans-serif; background-color: white; }
                            .minimal-list-content { padding: 30px; max-width: 500px; margin: 0 auto; }
                            .list-title { font-size: 20px; color: #006666; font-weight: bold; text-align: center; margin-bottom: 5px; }
                            .list-subtitle { font-size: 14px; color: #555; text-align: center; margin-bottom: 20px; }
                            .plan-list { list-style: none; padding: 0; margin: 0; }
                            .list-item { 
                                padding: 8px 0; 
                                border-bottom: 1px dashed #ddd;
                                display: flex;
                                font-size: 13px;
                            }
                            .prompt-item {
                                padding: 4px 0 8px 0;
                                font-size: 11px;
                                color: #444;
                                border-bottom: 1px dashed #ddd;
                                line-height: 1.3;
                            }
                            .day-ref { font-weight: bold; color: #008080; width: 30%; flex-shrink: 0; }
                            .scripture-ref { color: #006666; width: 70%; }
                            @media print {
                                .minimal-list-content { max-width: 100%; }
                            }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print(); // Triggers the browser print dialog (Save as PDF/Image)
        }

        // --- MAIN GENERATION LOGIC ---

        window.generatePlan = async function(event) {
            event.preventDefault();
            
            // FIX: Reset currentPlan and currentPlanDetails to ensure the save/share logic knows no valid plan exists yet
            window.currentPlan = null; 
            window.currentPlanDetails = null;

            const prompt = document.getElementById('prompt').value.trim();
            const duration = document.getElementById('duration').value;
            const verseCount = document.getElementById('max-verses').value; 
            const includePrompts = document.getElementById('journal-prompts').checked;
            const includePrayer = document.getElementById('prayer-prompt').checked; 

            if (!prompt || !duration || !verseCount) {
                displayError("Please fill out all required fields (Topic, Duration, and # of Verses).");
                return;
            }
            
            // Store plan details for saving/sharing metadata
            window.currentPlanDetails = {
                prompt, duration, maxVerses: verseCount, includePrompts, includePrayer
            };


            // UI State: Loading
            document.getElementById('loading-message').classList.remove('hidden');
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('plan-output').innerHTML = '';
            document.getElementById('generate-button').disabled = true;
            document.getElementById('spinner').classList.remove('hidden');
            document.getElementById('print-options').classList.add('hidden'); 


            // Dynamically build the plan type description
            const components = ['daily scripture reading'];
            if (includePrompts) components.push('reflection, and journal prompts');
            if (includePrayer) components.push('a prayer prompt');
            
            let planType = components.filter(Boolean).join(', ');
            planType = planType.replace(/,([^,]*)$/, ' and$1');
            
            // LOGIC FOR EXACT VERSE COUNT: Adjust query based on input
            let readingConstraint;
            if (verseCount === '1') {
                // FIX: If 1 verse, enforce single passage for maximum precision
                readingConstraint = `a single passage of **EXACTLY 1 verse**.`;
            } else {
                // If more than 1 verse, use the flexible multi-passage approach
                readingConstraint = `multiple passages whose total length is **EXACTLY ${verseCount} verses**. These passages should be drawn from **multiple, unique, non-contiguous references** across the Bible to provide a broad theological view of the theme.`;
            }

            // FIX: EXTREME PROMPT FIX - Instruct the model to generate a summary/devotional prose instead of full verses to avoid Recitation error.
            const systemPrompt = `You are a world-class, deeply knowledgeable theological assistant specializing in creating structured, daily Bible reading and reflection plans. Your task is to generate a comprehensive ${planType} based on the user's request.
            1. Theme/Topic: The plan must be focused on the user's specific input: "${prompt}".
            2. Duration: The plan must cover exactly ${duration} days.
            3. Scripture & Passage Text: Provide highly relevant, specific scripture references (Book Chapter:Verse-Verse). Crucially, for the 'passageText' field, **DO NOT output the full scripture text**. Instead, provide a brief, devotional summary (2-3 sentences) of the passage's meaning and context, ensuring the total prose length is short. The daily reading should be ${readingConstraint}
            4. Reflection: If requested, generate 2-3 thoughtful, non-generic reflection questions or journal prompts per day that encourage deep engagement with the scripture.
            5. Prayer: If requested, generate a concise, focused prayer prompt (a short sentence or two) for each day, related to the reading. If not requested, ensure the 'prayerPrompt' field is an empty string.
            6. Output: Your response MUST be a JSON array of objects conforming exactly to the provided schema. DO NOT include any text outside the JSON block.`;

            // Updated user query to reflect EXACT constraint
            const userQuery = `Create a ${duration}-day Bible reading plan focused on the topic: "${prompt}". The reading for each day must be ${readingConstraint} For each day, provide the scripture reference(s) AND a concise devotional summary of the passage's meaning. ${includePrompts ? 'Include relevant reflection questions/journal prompts.' : 'Do not include reflection questions.'} ${includePrayer ? 'Include a concise prayer prompt for each day.' : 'Do not include a prayer prompt.'}`;

            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "day": { "type": "INTEGER", "description": "The day number in the reading plan (1, 2, 3, etc.)." },
                        "theme": { "type": "STRING", "description": "A short, descriptive theme or title for the day's reading." },
                        "scripture": { "type": "STRING", "description": "The specific Bible reference(s) for the reading (e.g., 'Genesis 1:1-2:3, Psalm 23:1-6')." },
                        "passageText": { "type": "STRING", "description": "A devotional summary or paraphrase of the passage text (2-3 sentences)." },
                        "reflectionQuestions": {
                            "type": "ARRAY",
                            "description": "A list of 2-3 reflection questions or journal prompts. If the user did not request prompts, this array should be empty.",
                            "items": { "type": "STRING" }
                        },
                        "prayerPrompt": { "type": "STRING", "description": "A concise prayer prompt related to the day's theme. Use an empty string if not requested." }
                    },
                    required: ["day", "theme", "scripture", "passageText", "reflectionQuestions", "prayerPrompt"]
                }
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    
                    const parsedPlan = extractJson(jsonText);

                    if (Array.isArray(parsedPlan)) {
                        window.currentPlan = parsedPlan;
                        renderPlan(parsedPlan);
                        document.getElementById('plan-output-title').textContent = `Generated Plan for: ${prompt}`;
                        document.getElementById('plan-output-title').classList.remove('hidden');
                    } else {
                        throw new Error("Could not parse valid reading plan array from AI response.");
                    }
                } else {
                    // Check for blocked content
                    const finishReason = result.candidates?.[0]?.finishReason;
                    if (finishReason && finishReason.includes('SAFETY')) {
                        throw new Error("Generation blocked due to safety settings. Please try a different prompt.");
                    } else if (finishReason) {
                        throw new Error(`Generation failed: Model returned non-readable text. Reason: ${finishReason}`);
                    }
                     else {
                        // Throw original error for general failure
                        throw new Error("AI response structure was invalid or empty (API returned no readable text).");
                    }
                }

            } catch (error) {
                console.error("API or JSON Parsing Error:", error);
                displayError(`Failed to generate plan: ${error.message}. Please check your prompt and try again.`);
            } finally {
                // UI State: Done
                document.getElementById('loading-message').classList.add('hidden');
                document.getElementById('generate-button').disabled = false;
                document.getElementById('spinner').classList.add('hidden');
            }
        }
    </script>
    <style>
        /* Modernized Styles */
        .card {
            /* Using a softer, deeper shadow for modern elevation */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid #E5E7EB; /* Subtle border on card */
        }
        .card:hover {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        .bg-gray-50 { 
            background-color: #F8F8F8; /* Softer background */
        }
        
        /* REVERTED TO ORIGINAL VIBRANT COLORS */
        .text-primary-teal { color: #008080; } /* Primary text (teal) */
        .text-secondary-gold { color: #FFD700; } /* Accent text (gold) */
        .bg-primary-teal { background-color: #008080; }
        .bg-secondary-gold { background-color: #FFD700; color: #006666; } /* Buttons/Accents */
        .border-primary-teal { border-color: #008080; }
        .border-secondary-gold { border-color: #FFD700; } 
        .bg-gray-100 { background-color: #F3F4F6; }
        .text-dark-teal { color: #006666; }
        
        /* Modern Button Styles */
        button {
            border-radius: 10px;
        }
        #generate-button {
            background-color: #008080; 
        }
        #generate-button:hover {
            background-color: #006666; 
        }

        /* Generated Content Styling */
        #plan-output .card {
            border-left: 4px solid #008080; /* Use side border instead of top border for elegance */
            border-top: none;
            padding: 20px;
        }
        #plan-output h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* semi-bold */
        }
        #plan-output p[class*="text-lg"] {
            font-size: 1rem; /* Smaller, cleaner reference text */
            font-weight: 500;
        }
        /* New: Slimmer Newsletter Box */
        .newsletter-container {
            max-width: 480px; /* max-w-lg equivalent */
            padding: 16px; /* p-4 equivalent */
            margin: 1.5rem auto; /* mt-6 mb-10 */
        }
        /* Styles for the minimal print view */
        @media print {
            body { margin: 0; padding: 0; font-family: sans-serif; background-color: white; }
            .minimal-list-content { padding: 30px; max-width: 500px; margin: 0 auto; }
            .list-title { font-size: 20px; color: #006666; font-weight: bold; text-align: center; margin-bottom: 5px; }
            .list-subtitle { font-size: 14px; color: #555; text-align: center; margin-bottom: 20px; }
            .plan-list { list-style: none; padding: 0; margin: 0; }
            .list-item { 
                padding: 8px 0; 
                border-bottom: 1px dashed #ddd;
                display: flex;
                font-size: 13px;
            }
            .prompt-item {
                padding: 4px 0 8px 0;
                font-size: 11px;
                color: #444;
                border-bottom: 1px dashed #ddd;
                line-height: 1.3;
            }
            .day-ref { font-weight: bold; color: #008080; width: 30%; flex-shrink: 0; }
            .scripture-ref { color: #006666; width: 70%; }
        }

    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8 font-sans">

    <!-- Main App Content Wrapper (max-w-4xl) -->
    <div class="max-w-4xl mx-auto">
        
        <!-- Main Content Area -->
        <div>

            <!-- Updated Header -->
            <header class="text-center mb-10">
                <h1 class="text-5xl font-extrabold tracking-tight mb-1 text-primary-teal uppercase">
                    BIBLEPLAN<span class="text-secondary-gold">.AI</span>
                </h1>
                <!-- UPDATED SUBTITLE -->
                <p class="text-lg font-medium text-gray-700 italic border-b border-gray-300 pb-4 inline-block">your bible reading plan generator</p>
            </header>

            <!-- Input Form Card -->
            <div id="input-card" class="bg-white p-6 md:p-8 rounded-xl card mb-10">
                <h2 class="text-2xl font-semibold mb-6 text-primary-teal">Create Your Plan</h2>

                <form id="plan-form" onsubmit="generatePlan(event)">
                    <div class="space-y-6">
                        <div>
                            <!-- UPDATED LABEL: Removed specific examples -->
                            <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Topic or Book or Chapter, etc.</label>
                            <textarea id="prompt" name="prompt" rows="2" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-teal focus:border-primary-teal transition duration-150" 
                                placeholder="e.g., The Life of David, The Book of Romans, Forgiveness"></textarea>
                        </div>

                        <!-- Layout for Duration and # of Verses -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                            <div class="col-span-1">
                                <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">Duration (Days)</label>
                                <!-- MAX CHANGED FROM 90 TO 40 -->
                                <input type="number" id="duration" name="duration" required min="1" max="40" value="7" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-teal focus:border-primary-teal transition duration-150">
                                <p class="text-xs text-gray-500 mt-1">Max 40 days.</p>
                            </div>
                            
                            <!-- # OF VERSES INPUT -->
                            <div class="col-span-1">
                                <label for="max-verses" class="block text-sm font-medium text-gray-700 mb-2"># of verses/day</label>
                                <input type="number" id="max-verses" name="max-verses" required min="1" max="50" value="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-teal focus:border-primary-teal transition duration-150">
                                <p class="text-xs text-gray-500 mt-1">Limit reading length.</p>
                            </div>

                            <!-- Checkbox Group (Spanning the remaining two columns on desktop) -->
                            <div class="col-span-2 flex flex-col space-y-3 pt-6 md:pt-0"> 
                                <div class="flex items-center">
                                    <!-- REMOVED 'checked' attribute -->
                                    <input type="checkbox" id="journal-prompts" name="journal-prompts" class="h-5 w-5 text-dark-teal rounded border-gray-300 focus:ring-dark-teal">
                                    <label for="journal-prompts" class="ml-3 text-sm font-medium text-gray-700">Include Journal Prompts & Reflection Questions</label>
                                </div>
                                <!-- Prayer Checkbox - REMOVED 'checked' attribute -->
                                <div class="flex items-center">
                                    <input type="checkbox" id="prayer-prompt" name="prayer-prompt" class="h-5 w-5 text-dark-teal rounded border-gray-300 focus:ring-dark-teal">
                                    <label for="prayer-prompt" class="ml-3 text-sm font-medium text-gray-700">Include Daily Prayer Prompt</label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="generate-button" class="w-full bg-primary-teal text-white py-3 rounded-xl font-semibold hover:bg-dark-teal transition duration-300 focus:outline-none focus:ring-4 focus:ring-primary-teal focus:ring-opacity-50 flex items-center justify-center">
                            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Generate Reading Plan
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Print Options (Added Screenshot button) -->
            <div id="print-options" class="bg-white p-6 md:p-8 rounded-xl card mb-10 hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Output Options</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="screenshot-button" onclick="printMinimalList()" class="w-full bg-secondary-gold text-dark-teal py-3 rounded-xl font-semibold hover:bg-dark-teal transition duration-300 focus:outline-none focus:ring-4 focus:ring-secondary-gold focus:ring-opacity-50">
                        Save as Print Snapshot
                    </button>
                    <button onclick="printSimplePlan()" class="w-full bg-secondary-gold text-dark-teal py-3 rounded-xl font-semibold hover:bg-dark-teal transition duration-300 focus:outline-none focus:ring-4 focus:ring-secondary-gold focus:ring-opacity-50">
                        Print Detailed Plan
                    </button>
                    <button onclick="printHabitTracker()" class="w-full bg-secondary-gold text-dark-teal py-3 rounded-xl font-semibold hover:bg-dark-teal transition duration-300 focus:outline-none focus:ring-4 focus:ring-secondary-gold focus:ring-opacity-50">
                        Print Habit Tracker (Spreadsheet)
                    </button>
                </div>
            </div>

            <!-- Results Area -->
            <div id="results-area" class="mt-8">
                <div id="loading-message" class="text-center text-primary-teal font-medium hidden">
                    Generating your custom plan... this may take a few moments.
                </div>
                <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl hidden" role="alert">
                    <p class="font-bold">Error:</p>
                    <p id="error-text" class="text-sm"></p>
                </div>
                <h2 id="plan-output-title" class="text-3xl font-extrabold text-primary-teal mb-6 hidden"></h2>
                <div id="plan-output" class="space-y-6">
                    <!-- Generated plan will be inserted here -->
                </div>
            </div>

        </div> <!-- End Main Content Area -->

    </div> <!-- End Main App Content Wrapper -->

    <!-- HISTORY MOVED TO BOTTOM -->
    <div class="max-w-4xl mx-auto mt-12">
        <aside id="history-sidebar" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-xl font-bold text-dark-teal mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Plan History
            </h2>
            <div id="history-list" class="space-y-2 max-h-[40vh] overflow-y-auto">
                <p class="text-sm text-gray-500 p-2">Loading plans...</p>
            </div>
            <!-- FIX: Re-added the missing user-id-display element -->
            <p id="user-id-display" class="text-xs text-gray-400 mt-4 pt-2 border-t"></p> 
        </aside>
    </div>
    <!-- END HISTORY -->

    <!-- Footer content -->
    <footer class="mt-12 py-4 text-center text-gray-500 border-t border-gray-300">
        <p class="text-sm">
            created by 
            <a href="https://heyjerv.beehiiv.com" target="_blank" class="text-primary-teal hover:text-dark-teal font-semibold">taylor jervis</a>. 
            <a href="mailto:heyjerv@gmail.com" class="text-primary-teal hover:text-dark-teal font-semibold">contact</a> for help or to say hi.
        </p>
    </footer>
    
</body>
</html>
